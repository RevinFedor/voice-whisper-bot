58497c9a-6d3f-4ce4-af2a-8274b9271090

# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª–∫–∞–º–∏

## üìê –°—Ö–µ–º–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         ModalStackProvider          ‚îÇ ‚Üê –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ      NoteModal (100)        ‚îÇ   ‚îÇ ‚Üê –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ ExpandedTitle (800) ‚îÇ    ‚îÇ   ‚îÇ ‚Üê –í–ª–æ–∂–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ   TagInput (700)    ‚îÇ    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  AI Panels (500-600)‚îÇ    ‚îÇ   ‚îÇ ‚Üê –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ –ø–∞–Ω–µ–ª–∏
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ    DatePicker (100)         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

### Stack Management (LIFO)
```
–û—Ç–∫—Ä—ã–ª–∏: [NoteModal] ‚Üí [TitleAI] ‚Üí [TagInput]
Esc #1:  [NoteModal] ‚Üí [TitleAI] ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è TagInput
Esc #2:  [NoteModal] ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è TitleAI  
Esc #3:  [] ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è NoteModal
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
```javascript
MODAL_PRIORITIES = {
  DROPDOWN: 1000,        // –í—ã—Å—à–∏–π
  EXPANDED_INPUT: 800,   
  TAG_INPUT: 700,       
  PROMPT_PANEL: 600,    
  TAG_PANELS: 500,      
  NOTE_MODAL: 100,      // –û—Å–Ω–æ–≤–Ω—ã–µ
  DATE_PICKER: 100      
}
```

### –ì—Ä—É–ø–ø—ã –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏—è
```javascript
MODAL_GROUPS = {
  PANELS_GROUP: {
    mode: 'exclusive',
    modals: ['title-ai', 'title-history', 'tag-ai', 'tag-history', 'obsidian-tags']
  },
  INPUT_GROUP: {
    mode: 'parallel',
    modals: ['expanded-title', 'tag-input']
  }
}
```

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π A: –ü—Ä–æ—Å—Ç–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
```
NoteModal ‚Üí Esc ‚Üí –ó–∞–∫—Ä—ã—Ç–æ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π B: –í–ª–æ–∂–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
```
NoteModal ‚Üí ExpandedTitle ‚Üí Esc ‚Üí –°–≤–µ—Ä–Ω—É–ª—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫
                          ‚Üí Esc ‚Üí –ó–∞–∫—Ä—ã–ª–∞—Å—å –º–æ–¥–∞–ª–∫–∞
```

### –°—Ü–µ–Ω–∞—Ä–∏–π C: –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ –ø–∞–Ω–µ–ª–∏
```
NoteModal ‚Üí TitleAI ‚Üí TagHistory
            ‚Üì–∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ
         ‚Üí TagHistory –æ—Ç–∫—Ä—ã—Ç–∞
```

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### `/contexts/ModalStackContext.jsx`
- `ModalStackProvider` - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å—Ç–µ–∫–æ–º
- `useModalEscape(id, handler, priority, options)` - —Ö—É–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `registerModal()` / `unregisterModal()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–∫–æ–º

### `/components/NoteModal.jsx`
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ `useModalEscape`:
- –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–∞–ª–∫–∞
- –†–∞—Å–∫—Ä—ã—Ç—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
- Input —Ç–µ–≥–æ–≤  
- AI –ø–∞–Ω–µ–ª–∏ (—Å `group: 'PANELS_GROUP'`)

### `/components/DatePickerModal.jsx`
–ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–∞–ª–∫–∞ —Å –æ–¥–Ω–∏–º `useModalEscape`

## üéÆ –õ–æ–≥–∏–∫–∞ toggle-—Ñ—É–Ω–∫—Ü–∏–π

### –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ toggle
```javascript
toggleHistory() {
  setShowHistory(!showHistory)
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞–Ω–µ–ª–∏
  setShowPrompt(false)
  setShowTagChat(false)
  setShowTagHistory(false)
  setShowObsidianTags(false)
}
```

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- `testModalEscape.help()` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `checkPriorities()` - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
- `window.debugModalStack()` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–µ–∫–∞

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
- `üìå Registering modal` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `üìö Modal stack updated` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–µ–∫–∞
- `‚å®Ô∏è Escape pressed` - –Ω–∞–∂–∞—Ç–∏–µ –∫–ª–∞–≤–∏—à–∏
- `‚úÖ Escape handled by` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–ª

## üöÄ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –º–æ–¥–∞–ª–∫–∏
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ `MODAL_PRIORITIES`
2. –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞–µ–º–æ—Å—Ç—å
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `useModalEscape` –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å toggle —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –¥—Ä—É–≥–∏—Ö –ø–∞–Ω–µ–ª–µ–π

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
```javascript
useModalEscape(
  `${modalId}-my-panel`,
  () => {
    if (showMyPanel) {
      setShowMyPanel(false)
      return true  // –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ
    }
    return false   // –ü–µ—Ä–µ–¥–∞—Ç—å –¥–∞–ª—å—à–µ
  },
  showMyPanel ? PRIORITY : -1,
  { group: 'PANELS_GROUP', exclusive: true }
)
```

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ú–æ–¥–∞–ª–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ
- **NoteModal** - –æ—Å–Ω–æ–≤–Ω–∞—è —Å 5 –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏
- **DatePickerModal** - –ø—Ä–æ—Å—Ç–∞—è –±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
- **5 –ø–∞–Ω–µ–ª–µ–π** - –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ (AI —á–∞—Ç—ã, –∏—Å—Ç–æ—Ä–∏–∏, —Ç–µ–≥–∏)
- **2 input** - –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –û–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π listener –Ω–∞ `document`
- Capture phase –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –¥–æ bubbling
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
- Cleanup –ø—Ä–∏ unmount –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤