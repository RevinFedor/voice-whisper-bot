# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω

## üìê –°—Ö–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```
ModalStackProvider (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
    ‚îî‚îÄ> Stack –º–æ–¥–∞–ª–æ–∫ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
            ‚îî‚îÄ> –ì—Ä—É–ø–ø—ã –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏—è
                    ‚îî‚îÄ> Escape-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
```

## üöá –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–æ–Ω–Ω–µ–ª–µ–π

### –¢–æ–Ω–Ω–µ–ª—å A: –ü—Ä–æ—Å—Ç–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
```
NoteModal ‚Üí Esc ‚Üí –ó–∞–∫—Ä—ã—Ç–æ
```
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `NoteModal.jsx:1150` - –±–∞–∑–æ–≤—ã–π `useModalEscape`

### –¢–æ–Ω–Ω–µ–ª—å B: –í–ª–æ–∂–µ–Ω–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è
```
NoteModal ‚Üí ExpandedTitle(800) ‚Üí TagInput(700) ‚Üí AI Panel(500)
     Esc ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Esc ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Esc ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Esc
```
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤ `ModalStackContext.jsx:15-25`

### –¢–æ–Ω–Ω–µ–ª—å C: –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
```
TitleAI ‚îÄ‚îÄ‚îê
TagHistory ‚îú‚îÄ> PANELS_GROUP (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–µ–Ω)
TagAI ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `group: 'PANELS_GROUP'` –≤ `NoteModal.jsx:1180-1250`

### –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Ç–æ–Ω–Ω–µ–ª–∏ (Z-index)
```
Dropdown(1000) > ExpandedInput(800) > TagInput(700) > Panels(500) > Base(100)
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–∞–ª–æ–∫ —Å –≥—Ä—É–ø–ø–∞–º–∏

### –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```javascript
// contexts/ModalStackContext.jsx:15-25
MODAL_PRIORITIES = {
  DROPDOWN: 1000,
  EXPANDED_INPUT: 800,   
  TAG_INPUT: 700,       
  PROMPT_PANEL: 600,    
  TAG_PANELS: 500,      
  NOTE_MODAL: 100
}

// contexts/ModalStackContext.jsx:27-35
MODAL_GROUPS = {
  PANELS_GROUP: {
    mode: 'exclusive',
    modals: ['title-ai', 'title-history', 'tag-ai', 'tag-history', 'obsidian-tags']
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
```javascript
// components/NoteModal.jsx:1180
useModalEscape(
  `${modalId}-title-ai`,
  handleClose,
  showPrompt ? PRIORITY : -1,
  { group: 'PANELS_GROUP', exclusive: true }
)
```

## üîß –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∏—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

### ModalStackContext.jsx
- `registerModal(id, handler, priority, options)` - –ª–∏–Ω–∏—è 45
- `unregisterModal(id)` - –ª–∏–Ω–∏—è 78  
- `handleGlobalEscape()` - –ª–∏–Ω–∏—è 95
- `sortModalsByPriority()` - –ª–∏–Ω–∏—è 120

### NoteModal.jsx
- `toggleHistory()` - –ª–∏–Ω–∏—è 850 (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏)
- `togglePrompt()` - –ª–∏–Ω–∏—è 865
- `toggleTagChat()` - –ª–∏–Ω–∏—è 880
- `toggleTagHistory()` - –ª–∏–Ω–∏—è 895
- `toggleObsidianTags()` - –ª–∏–Ω–∏—è 910

### –•—É–∫–∏ escape (NoteModal.jsx)
- –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–∞–ª–∫–∞: –ª–∏–Ω–∏—è 1150
- –†–∞—Å–∫—Ä—ã—Ç—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫: –ª–∏–Ω–∏—è 1160  
- Input —Ç–µ–≥–æ–≤: –ª–∏–Ω–∏—è 1170
- AI –ø–∞–Ω–µ–ª–∏: –ª–∏–Ω–∏–∏ 1180-1250 (5 —à—Ç—É–∫ —Å –≥—Ä—É–ø–ø–æ–π)

## üéÆ –ü–∞—Ç—Ç–µ—Ä–Ω toggle —Å –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º

```javascript
// components/NoteModal.jsx:850
toggleHistory() {
  setShowHistory(!showHistory)
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ
  setShowPrompt(false)
  setShowTagChat(false)
  setShowTagHistory(false)
  setShowObsidianTags(false)
}
```

## üîç Debug-—É—Ç–∏–ª–∏—Ç—ã

```javascript
window.debugModalStack()     // contexts/ModalStackContext.jsx:200
window.testModalEscape.help() // utils/modalTestHelpers.js:10
window.checkPriorities()      // utils/modalTestHelpers.js:25
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–µ–∫–∞ –≤ runtime

```javascript
// –ü—Ä–∏–º–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–µ–∫–∞
modalStack = [
  { id: 'note-123', priority: 100, handler: fn },
  { id: 'note-123-title', priority: 800, handler: fn },
  { id: 'note-123-title-ai', priority: 600, handler: fn, group: 'PANELS_GROUP' }
]
// –ü—Ä–∏ Esc –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
```

## üöÄ –ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –º–æ–¥–∞–ª–∫–∏

1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ `MODAL_PRIORITIES` (ModalStackContext.jsx:15)
2. –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (ModalStackContext.jsx:27)
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö—É–∫ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:
```javascript
useModalEscape(id, handler, priority, { group: 'MY_GROUP' })
```
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å toggle —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –¥—Ä—É–≥–∏—Ö (–ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É –∏–∑ NoteModal.jsx:850)

---

## ü§ñ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–õ–Ø AI –ú–û–î–ï–õ–ï–ô - –ü–†–ê–í–ò–õ–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ú–û–î–ê–õ–û–ö

### ‚ö†Ô∏è –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

**–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞:** –£–¥–∞–ª–µ–Ω–∏–µ, –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –≤–∞–∂–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

**–®–∞–≥–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
1. –°–æ–∑–¥–∞–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ `/components/modals/ConfirmModal.jsx`:
```javascript
import { useModalEscape } from '../../contexts/ModalStackContext'

function ConfirmModal({ isOpen, onClose, onConfirm, title, message, confirmText = "–î–∞", cancelText = "–û—Ç–º–µ–Ω–∞" }) {
  useModalEscape(
    'confirm-modal',
    () => { onClose(); return true },
    isOpen ? 200 : -1  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –º–µ–∂–¥—É –±–∞–∑–æ–≤—ã–º–∏ –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏
  )
  
  if (!isOpen) return null
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-white rounded-lg p-6 max-w-md">
        <h3>{title}</h3>
        <p>{message}</p>
        <button onClick={onConfirm}>{confirmText}</button>
        <button onClick={onClose}>{cancelText}</button>
      </div>
    </div>
  )
}
```

2. –ò—Å–ø–æ–ª—å–∑—É–π –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:
```javascript
const [showDeleteConfirm, setShowDeleteConfirm] = useState(false)

<ConfirmModal 
  isOpen={showDeleteConfirm}
  onClose={() => setShowDeleteConfirm(false)}
  onConfirm={handleDelete}
  title="–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏?"
  message={`–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedNotes.length} –∑–∞–º–µ—Ç–æ–∫?`}
/>
```

### üîî Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ö–æ–≥–¥–∞ –Ω—É–∂–Ω—ã:** –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –æ—à–∏–±–∫–∏, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–ò—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—ã–π —Ö—É–∫:** `/hooks/useToast.js`
```javascript
import { useToast } from '../hooks/useToast'

const { showToast } = useToast()

// –£—Å–ø–µ—Ö
showToast('–ó–∞–º–µ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω—ã', 'success')

// –û—à–∏–±–∫–∞  
showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error')

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
showToast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'info')
```

### üí° –¢—É–ª—Ç–∏–ø—ã

**–ö–æ–≥–¥–∞ –Ω—É–∂–Ω—ã:** –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏

**–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:** `/components/common/Tooltip.jsx`
```javascript
import Tooltip from '../common/Tooltip'

<Tooltip content="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏">
  <button>üóëÔ∏è</button>
</Tooltip>
```

### üìå –ú–æ–¥–∞–ª–∫–∞ —Å AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –¥–ª—è –∑–∞–º–µ—Ç–æ–∫)

**–î–ª—è AI-—Ç–µ–≥–æ–≤ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:**
```javascript
// 1. –ü—Ä–æ–≤–µ—Ä—å –µ—Å—Ç—å –ª–∏ –∑–∞–º–µ—Ç–∫–∏ –±–µ–∑ —Ç–µ–≥–æ–≤
const notesWithoutTags = selectedNotes.filter(note => !note.tags?.length)

// 2. –ü–æ–∫–∞–∂–∏ –º–æ–¥–∞–ª–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
if (notesWithoutTags.length > 0) {
  setShowAITagsConfirm(true)
  setNotesForAI(notesWithoutTags)
}

// 3. –í –º–æ–¥–∞–ª–∫–µ –ø—Ä–µ–¥–ª–æ–∂–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
<ConfirmModal
  title="–î–æ–±–∞–≤–∏—Ç—å AI-—Ç–µ–≥–∏?"
  message={`–£ ${notesWithoutTags.length} –∑–∞–º–µ—Ç–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ–≥–∏. –î–æ–±–∞–≤–∏—Ç—å AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏?`}
  onConfirm={async () => {
    for (const note of notesWithoutTags) {
      await generateAITags(note.id)  // –ò—Å–ø–æ–ª—å–∑—É–π —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
    }
    await exportToObsidian(selectedNotes)
  }}
/>
```

### üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

**–í–ê–ñ–ù–û:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π:
1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç** - –º–µ–∂–¥—É 100-1000 (—Å–º. MODAL_PRIORITIES)
2. **–ì—Ä—É–ø–ø—É** - –Ω—É–∂–Ω–∞ –ª–∏ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞–µ–º–æ—Å—Ç—å
3. **Z-index** - —á—Ç–æ–±—ã –º–æ–¥–∞–ª–∫–∞ –±—ã–ª–∞ –ø–æ–≤–µ—Ä—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
4. **Escape** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π `useModalEscape`

### üéØ –ì–æ—Ç–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

**–£–¥–∞–ª–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º:**
```javascript
const handleDeleteClick = () => {
  setDeleteConfirmData({
    isOpen: true,
    items: selectedNotes,
    onConfirm: async () => {
      await api.deleteNotes(selectedNotes.map(n => n.id))
      showToast('–£–¥–∞–ª–µ–Ω–æ', 'success')
      refreshNotes()
    }
  })
}
```

**–≠–∫—Å–ø–æ—Ä—Ç —Å AI-–ø—Ä–æ–≤–µ—Ä–∫–æ–π:**
```javascript
const handleExportClick = () => {
  const needsAI = selectedNotes.some(n => !n.tags?.length)
  if (needsAI) {
    setShowAIConfirm(true)
  } else {
    exportToObsidian(selectedNotes)
  }
}
```

### ‚ö° –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è AI –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–æ–¥–∞–ª–∫–∏

- [ ] –û–ø—Ä–µ–¥–µ–ª–∏–ª —Ç–∏–ø –º–æ–¥–∞–ª–∫–∏ (confirm/toast/tooltip/custom)
- [ ] –í—ã–±—Ä–∞–ª –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (100-1000)
- [ ] –î–æ–±–∞–≤–∏–ª `useModalEscape` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ Escape
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª z-index –¥–ª—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è
- [ ] –î–æ–±–∞–≤–∏–ª –≤ –≥—Ä—É–ø–ø—É –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞–µ–º–æ—Å—Ç—å
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- [ ] –î–æ–±–∞–≤–∏–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

